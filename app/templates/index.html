<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Список задач</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #444; }
        .add-form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .add-form input, .add-form textarea { border: 2px solid #ddd; padding: 10px; border-radius: 6px; font-family: inherit; }
        .add-form button { background-color: #5c67f2; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 1em; }
        .task { border-bottom: 1px solid #eee; padding: 15px 10px; }
        .task.done { opacity: 0.6; }
        .task-header { display: flex; align-items: center; gap: 15px; }
        .task-title { flex-grow: 1; font-weight: bold; }
        .task.done .task-title { text-decoration: line-through; }
        .task-description { margin-top: 8px; font-size: 0.9em; color: #666; }
        .task-due-date { font-size: 0.8em; color: #555; margin-top: 8px; }
        .countdown { font-weight: bold; }
        .task.expired .task-due-date { color: #e53e3e; }
        .task.expired .countdown { color: #e53e3e; }
        .task-actions { margin-top: 10px; }
        .task-actions button { background-color: #eee; color: #333; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .task-actions .delete-btn { background-color: #fbecec; color: #c53030; border-color: #f5c6cb; }
        .task-actions .reactivate-btn { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Мой список задач</h1>
        <form action="/tasks/" method="post" class="add-form">
            <input type="text" name="title" placeholder="Название задачи" required>
            <textarea name="description" placeholder="Описание (необязательно)"></textarea>
            <input type="datetime-local" name="due_date">
            <button type="submit">Добавить</button>
        </form>

        <div>
            {% for task in tasks %}
            <div class="task {% if task.is_done %}done{% endif %} {% if not task.is_done and task.due_date and task.due_date < current_time %}expired{% endif %}"
                 id="task-{{ task.id }}">
                <div class="task-header">
                    <span class="task-title">{{ task.title }}</span>
                </div>
                {% if task.description %}
                    <p class="task-description">{{ task.description }}</p>
                {% endif %}
                {% if task.due_date %}
                    <p class="task-due-date">
                        Срок: {{ task.due_date.strftime('%d.%m.%Y в %H:%M') }}
                        <span class="countdown" {% if task.due_date %}data-due-date="{{ task.due_date.isoformat() }}"{% endif %}></span>
                    </p>
                {% endif %}
                <div class="task-actions">
                    {% if task.is_done %}
                        <form action="/tasks/{{ task.id }}/reactivate" method="post" style="display: inline;">
                            <button type="submit" class="reactivate-btn">↩️ Вернуть в работу</button>
                        </form>
                    {% else %}
                        <form action="/tasks/{{ task.id }}/complete" method="post" style="display: inline;">
                            <button type="submit">✅ Завершить</button>
                        </form>
                        <form action="/tasks/{{ task.id }}/delete" method="post" style="display: inline;">
                            <button type="submit" class="delete-btn">❌ Удалить</button>
                        </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function updateTimers() {
                const countdownElements = document.querySelectorAll('.countdown');
                countdownElements.forEach(el => {
                    const dueDateStr = el.dataset.dueDate;
                    if (!dueDateStr) return;
                    const dueDate = new Date(dueDateStr).getTime();
                    const now = new Date().getTime();
                    const diff = dueDate - now;
                    const parentTask = el.closest('.task');
                    if (parentTask.classList.contains('done')) {
                        el.textContent = '';
                        return;
                    }
                    if (diff <= 0) {
                        el.textContent = '— Срок истёк!';
                        if (!parentTask.classList.contains('expired')) {
                            parentTask.classList.add('expired');
                        }
                        return;
                    }
                    const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diff % (1000 * 60)) / 1000);
                    let text = '— Осталось: ';
                    if (d > 0) text += `${d}д `;
                    if (h > 0 || d > 0) text += `${h}ч `;
                    text += `${m}м ${s}с`;
                    el.textContent = text;
                });
            }
            updateTimers();
            setInterval(updateTimers, 1000);
        });
    </script>
</body>
</html>